import React, { useState, useEffect } from 'react';
import { Play, Pause, RefreshCw, AlertTriangle, CheckCircle, TrendingUp, Package, Wrench, Calendar } from 'lucide-react';

const AutoPartsSimulation = () => {
  const [isRunning, setIsRunning] = useState(false);
  const [time, setTime] = useState(0);
  const [logs, setLogs] = useState([]);
  const [metrics, setMetrics] = useState({
    defectRate: 15,
    uptime: 85,
    onTimeDelivery: 78,
    qualityInspections: 0,
    predictedFailures: 0,
    scheduledOptimizations: 0
  });

  const [activeAlerts, setActiveAlerts] = useState([]);
  const [productionQueue, setProductionQueue] = useState([
    { id: 'ORD-001', part: 'Brake Rotor', status: 'in-progress', priority: 'high', completion: 65 },
    { id: 'ORD-002', part: 'Control Arm', status: 'queued', priority: 'medium', completion: 0 },
    { id: 'ORD-003', part: 'Custom Bracket', status: 'queued', priority: 'high', completion: 0 }
  ]);

  const [machineStatus, setMachineStatus] = useState([
    { id: 'CNC-01', status: 'operational', health: 92, nextMaintenance: '14 days' },
    { id: 'CNC-02', status: 'operational', health: 76, nextMaintenance: '3 days' },
    { id: 'MILL-01', status: 'operational', health: 88, nextMaintenance: '8 days' },
    { id: 'LATHE-01', status: 'operational', health: 95, nextMaintenance: '21 days' }
  ]);

  const addLog = (agent, message, type = 'info') => {
    const timestamp = new Date(Date.now() + time * 1000).toLocaleTimeString();
    setLogs(prev => [{
      timestamp,
      agent,
      message,
      type
    }, ...prev.slice(0, 19)]);
  };

  useEffect(() => {
    if (!isRunning) return;

    const interval = setInterval(() => {
      setTime(prev => prev + 1);
      
      // Quality Assurance Agent actions
      if (Math.random() > 0.7) {
        const defectFound = Math.random() > 0.85;
        setMetrics(prev => ({
          ...prev,
          qualityInspections: prev.qualityInspections + 1,
          defectRate: Math.max(3, prev.defectRate - 0.2)
        }));
        
        if (defectFound) {
          addLog('QAA', 'Defect detected: Dimension out of tolerance (Â±0.003mm). Root cause: Tool wear on CNC-01', 'warning');
          setActiveAlerts(prev => [...prev, {
            id: Date.now(),
            agent: 'QAA',
            message: 'Quality issue detected - Tool replacement recommended',
            severity: 'medium'
          }]);
        } else {
          addLog('QAA', 'Component inspected: All dimensions within tolerance', 'success');
        }
      }

      // Predictive Maintenance Agent actions
      if (Math.random() > 0.8) {
        const machineIdx = Math.floor(Math.random() * machineStatus.length);
        const machine = machineStatus[machineIdx];
        
        if (machine.health < 80) {
          setMetrics(prev => ({
            ...prev,
            predictedFailures: prev.predictedFailures + 1,
            uptime: Math.min(98, prev.uptime + 0.15)
          }));
          
          addLog('PMA', `Anomaly detected on ${machine.id}: Vibration levels elevated. Predicted failure in 48 hours. Maintenance scheduled.`, 'warning');
          
          setMachineStatus(prev => prev.map((m, idx) => 
            idx === machineIdx ? { ...m, health: Math.min(95, m.health + 15), nextMaintenance: '2 days' } : m
          ));
          
          setActiveAlerts(prev => [...prev, {
            id: Date.now(),
            agent: 'PMA',
            message: `${machine.id} requires maintenance - Auto-scheduled`,
            severity: 'high'
          }]);
        } else {
          addLog('PMA', `${machine.id} operating normally. All parameters within range.`, 'success');
        }
      }

      // Dynamic Production Orchestration Agent actions
      if (Math.random() > 0.75) {
        setMetrics(prev => ({
          ...prev,
          scheduledOptimizations: prev.scheduledOptimizations + 1,
          onTimeDelivery: Math.min(95, prev.onTimeDelivery + 0.2)
        }));
        
        setProductionQueue(prev => prev.map(order => {
          if (order.status === 'in-progress') {
            const newCompletion = Math.min(100, order.completion + Math.random() * 8);
            if (newCompletion >= 100) {
              addLog('DPOA', `Order ${order.id} (${order.part}) completed. Next batch optimized for CNC-02.`, 'success');
              return { ...order, status: 'completed', completion: 100 };
            }
            return { ...order, completion: newCompletion };
          } else if (order.status === 'queued' && Math.random() > 0.7) {
            addLog('DPOA', `Order ${order.id} started on optimal machine based on current capacity and priority.`, 'info');
            return { ...order, status: 'in-progress', completion: 5 };
          }
          return order;
        }));
      }

      // Clear old alerts
      if (Math.random() > 0.9) {
        setActiveAlerts(prev => prev.slice(0, 3));
      }

    }, 1500);

    return () => clearInterval(interval);
  }, [isRunning, time, machineStatus]);

  const resetSimulation = () => {
    setTime(0);
    setLogs([]);
    setMetrics({
      defectRate: 15,
      uptime: 85,
      onTimeDelivery: 78,
      qualityInspections: 0,
      predictedFailures: 0,
      scheduledOptimizations: 0
    });
    setActiveAlerts([]);
    setProductionQueue([
      { id: 'ORD-001', part: 'Brake Rotor', status: 'in-progress', priority: 'high', completion: 65 },
      { id: 'ORD-002', part: 'Control Arm', status: 'queued', priority: 'medium', completion: 0 },
      { id: 'ORD-003', part: 'Custom Bracket', status: 'queued', priority: 'high', completion: 0 }
    ]);
    setMachineStatus([
      { id: 'CNC-01', status: 'operational', health: 92, nextMaintenance: '14 days' },
      { id: 'CNC-02', status: 'operational', health: 76, nextMaintenance: '3 days' },
      { id: 'MILL-01', status: 'operational', health: 88, nextMaintenance: '8 days' },
      { id: 'LATHE-01', status: 'operational', health: 95, nextMaintenance: '21 days' }
    ]);
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold mb-2">AutoParts Inc. - Smart Manufacturing Simulation</h1>
          <p className="text-gray-400">Real-time demonstration of three AI agents optimizing manufacturing operations</p>
        </div>

        {/* Controls */}
        <div className="bg-gray-800 rounded-lg p-4 mb-6 flex items-center justify-between">
          <div className="flex gap-4">
            <button
              onClick={() => setIsRunning(!isRunning)}
              className={`flex items-center gap-2 px-6 py-2 rounded ${
                isRunning ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700'
              } transition-colors`}
            >
              {isRunning ? <Pause size={20} /> : <Play size={20} />}
              {isRunning ? 'Pause' : 'Start'} Simulation
            </button>
            <button
              onClick={resetSimulation}
              className="flex items-center gap-2 px-6 py-2 rounded bg-gray-700 hover:bg-gray-600 transition-colors"
            >
              <RefreshCw size={20} />
              Reset
            </button>
          </div>
          <div className="text-xl font-mono">
            Runtime: {Math.floor(time / 60)}:{(time % 60).toString().padStart(2, '0')}
          </div>
        </div>

        {/* KPI Dashboard */}
        <div className="grid grid-cols-3 gap-4 mb-6">
          <div className="bg-gradient-to-br from-blue-900 to-blue-800 rounded-lg p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">Defect Rate</h3>
              <TrendingUp className="text-blue-300" size={24} />
            </div>
            <div className="text-4xl font-bold">{metrics.defectRate.toFixed(1)}%</div>
            <div className="text-sm text-blue-200 mt-2">Target: &lt;3% | Initial: 15%</div>
            <div className="text-xs text-gray-400 mt-1">Inspections: {metrics.qualityInspections}</div>
          </div>

          <div className="bg-gradient-to-br from-green-900 to-green-800 rounded-lg p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">Machine Uptime</h3>
              <Wrench className="text-green-300" size={24} />
            </div>
            <div className="text-4xl font-bold">{metrics.uptime.toFixed(1)}%</div>
            <div className="text-sm text-green-200 mt-2">Target: &gt;95% | Initial: 85%</div>
            <div className="text-xs text-gray-400 mt-1">Failures Prevented: {metrics.predictedFailures}</div>
          </div>

          <div className="bg-gradient-to-br from-purple-900 to-purple-800 rounded-lg p-6">
            <div className="flex items-center justify-between mb-2">
              <h3 className="text-lg font-semibold">On-Time Delivery</h3>
              <Calendar className="text-purple-300" size={24} />
            </div>
            <div className="text-4xl font-bold">{metrics.onTimeDelivery.toFixed(1)}%</div>
            <div className="text-sm text-purple-200 mt-2">Target: &gt;95% | Initial: 78%</div>
            <div className="text-xs text-gray-400 mt-1">Optimizations: {metrics.scheduledOptimizations}</div>
          </div>
        </div>

        {/* Active Alerts */}
        {activeAlerts.length > 0 && (
          <div className="bg-yellow-900/30 border border-yellow-700 rounded-lg p-4 mb-6">
            <h3 className="text-lg font-semibold mb-3 flex items-center gap-2">
              <AlertTriangle size={20} className="text-yellow-500" />
              Active Alerts
            </h3>
            <div className="space-y-2">
              {activeAlerts.map(alert => (
                <div key={alert.id} className="flex items-center gap-3 text-sm">
                  <span className={`px-2 py-1 rounded text-xs font-semibold ${
                    alert.severity === 'high' ? 'bg-red-700' : 'bg-yellow-700'
                  }`}>
                    {alert.agent}
                  </span>
                  <span>{alert.message}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        <div className="grid grid-cols-2 gap-6 mb-6">
          {/* Production Queue */}
          <div className="bg-gray-800 rounded-lg p-6">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <Package size={20} />
              Production Queue (DPOA)
            </h3>
            <div className="space-y-3">
              {productionQueue.map(order => (
                <div key={order.id} className="bg-gray-700 rounded p-3">
                  <div className="flex justify-between mb-2">
                    <div>
                      <span className="font-semibold">{order.id}</span>
                      <span className="text-gray-400 ml-2">{order.part}</span>
                    </div>
                    <span className={`px-2 py-1 rounded text-xs ${
                      order.priority === 'high' ? 'bg-red-700' : 'bg-blue-700'
                    }`}>
                      {order.priority}
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-gray-600 rounded-full h-2">
                      <div 
                        className="bg-green-500 h-2 rounded-full transition-all duration-300"
                        style={{ width: `${order.completion}%` }}
                      />
                    </div>
                    <span className="text-sm">{order.completion.toFixed(0)}%</span>
                  </div>
                  <div className="text-xs text-gray-400 mt-1">{order.status}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Machine Status */}
          <div className="bg-gray-800 rounded-lg p-6">
            <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <Wrench size={20} />
              Machine Health (PMA)
            </h3>
            <div className="space-y-3">
              {machineStatus.map(machine => (
                <div key={machine.id} className="bg-gray-700 rounded p-3">
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold">{machine.id}</span>
                    <span className="text-sm text-gray-400">Next: {machine.nextMaintenance}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="flex-1 bg-gray-600 rounded-full h-2">
                      <div 
                        className={`h-2 rounded-full transition-all duration-300 ${
                          machine.health >= 90 ? 'bg-green-500' : 
                          machine.health >= 80 ? 'bg-yellow-500' : 'bg-red-500'
                        }`}
                        style={{ width: `${machine.health}%` }}
                      />
                    </div>
                    <span className="text-sm">{machine.health}%</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Activity Log */}
        <div className="bg-gray-800 rounded-lg p-6">
          <h3 className="text-lg font-semibold mb-4">Real-Time Activity Log</h3>
          <div className="bg-gray-900 rounded p-4 font-mono text-xs h-64 overflow-y-auto">
            {logs.map((log, idx) => (
              <div key={idx} className={`mb-1 ${
                log.type === 'warning' ? 'text-yellow-400' :
                log.type === 'success' ? 'text-green-400' : 'text-gray-300'
              }`}>
                <span className="text-gray-500">[{log.timestamp}]</span>
                <span className={`ml-2 px-2 py-0.5 rounded ${
                  log.agent === 'QAA' ? 'bg-blue-900' :
                  log.agent === 'PMA' ? 'bg-green-900' : 'bg-purple-900'
                }`}>
                  {log.agent}
                </span>
                <span className="ml-2">{log.message}</span>
              </div>
            ))}
            {logs.length === 0 && (
              <div className="text-gray-500 text-center mt-20">
                Start simulation to see agent activities...
              </div>
            )}
          </div>
        </div>

        {/* Legend */}
        <div className="mt-6 bg-gray-800 rounded-lg p-4">
          <h4 className="font-semibold mb-2">Agent Legend:</h4>
          <div className="grid grid-cols-3 gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded bg-blue-900 text-xs">QAA</span>
              <span>Quality Assurance Agent - Defect detection & root cause analysis</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded bg-green-900 text-xs">PMA</span>
              <span>Predictive Maintenance Agent - Equipment monitoring & failure prevention</span>
            </div>
            <div className="flex items-center gap-2">
              <span className="px-2 py-1 rounded bg-purple-900 text-xs">DPOA</span>
              <span>Dynamic Production Orchestration - Scheduling & resource optimization</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default AutoPartsSimulation;
